<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Bil‑inclinometer</title>
  <style>
    :root { color-scheme: dark; }
    html,body { margin:0; height:100%; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { min-height:100%; display:flex; flex-direction:column; align-items:center; gap:16px; padding:16px; }
    header { width:100%; max-width:640px; display:flex; justify-content:space-between; align-items:center; }
    h1 { font-size:18px; margin:0; font-weight:600; letter-spacing:0.2px; }
    button { background:#e5e7eb; color:#000; border:0; padding:10px 14px; border-radius:14px; font-weight:600; }
    button.secondary { background:#27272a; color:#fff; border:1px solid #3f3f46; }
    button.ghost { background:transparent; color:#fff; border:1px solid #3f3f46; }
    .card { width:100%; max-width:640px; background:#0a0a0a; border:1px solid #27272a; border-radius:16px; }
    .card h2 { margin:0; padding:12px 14px; font-size:14px; color:#e5e7eb; border-bottom:1px solid #27272a; }
    .card .content { padding:14px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; align-items:center; }
    .value { display:flex; align-items:baseline; justify-content:space-between; }
    .label { font-size:12px; color:#d4d4d8; }
    .sub { font-size:10px; color:#a1a1aa; }
    .num { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-variant-numeric: tabular-nums; }
    .num.big { font-size:32px; }
    .num.sm { font-size:20px; }
    .row { display:flex; gap:8px; }
    .hint { font-size:11px; color:#a1a1aa; line-height:1.4; }
    .gauge { position:relative; width:100%; aspect-ratio:1/1; }
    .ring { position:absolute; inset:0; border-radius:999px; border:1px solid #3f3f46; }
    .tick text { fill:#a1a1aa; font-size:10px; }
    .hline { position:absolute; left:0; right:0; top:50%; height:1px; background:#52525b; transform-origin:50% 0%; }
    .bubble { position:absolute; left:50%; top:50%; width:38px; height:38px; margin-left:-19px; margin-top:-19px;
              border-radius:999px; background:rgba(74,222,128,0.25); border:1px solid rgba(110,231,183,0.6); backdrop-filter: blur(2px); }
    .footer { font-size:10px; color:#a1a1aa; padding-bottom:8px; }
    .slider { width:100%; }
    input[type=range] { width:100%; -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-runnable-track { height:4px; background:#3f3f46; border-radius:999px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width:18px; height:18px; border-radius:50%; background:#e5e7eb; margin-top:-7px; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Bil‑inclinometer</h1>
    <div class="row">
      <button id="fsBtn" class="secondary" title="Helskärm">Helskärm</button>
      <button id="startBtn">Starta sensorer</button>
      <button id="stopBtn" class="ghost" style="display:none">Stoppa</button>
    </div>
  </header>

  <section class="card">
    <h2>Lutning nu</h2>
    <div class="content">
      <div class="grid">
        <div class="gauge">
          <div class="ring"></div>
          <div id="ticks"></div>
          <div id="hline" class="hline"></div>
          <div id="bubble" class="bubble"></div>
          <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; text-align:center;">
            <div>
              <div id="rollTxt" class="num big">0.0°</div>
              <div class="sub">vänster/höger</div>
            </div>
          </div>
        </div>
        <div>
          <div class="value">
            <div>
              <div class="label">Roll</div>
              <div class="sub">vänster/höger</div>
            </div>
            <div id="rollNum" class="num big">0.0°</div>
          </div>
          <div class="value" style="margin-top:8px">
            <div>
              <div class="label">Pitch</div>
              <div class="sub">fram/bak</div>
            </div>
            <div id="pitchNum" class="num big">0.0°</div>
          </div>
          <div class="value" style="margin-top:8px">
            <div>
              <div class="label">Stigning</div>
              <div class="sub">≈ tan(pitch)·100</div>
            </div>
            <div id="gradeNum" class="num sm">0.0 %</div>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="zeroBoth" class="secondary">Nollställ</button>
            <button id="zeroRoll" class="ghost">Nollställ roll</button>
            <button id="zeroPitch" class="ghost">Nollställ pitch</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Inställningar</h2>
    <div class="content">
      <div style="display:flex; align-items:center; gap:10px">
        <div class="label" style="min-width:110px">Filterstyrka</div>
        <input id="alpha" type="range" min="0.01" max="0.5" step="0.01" value="0.15" class="slider">
        <div id="alphaVal" class="num sm">0.15</div>
      </div>
      <p class="hint" style="margin-top:8px">
        Tips: Lägg telefonen plant där du vill ha nolläget och tryck <b>Nollställ</b>.
        På iPhone krävs ett tryck på <b>Starta sensorer</b> för att ge rörelsedata.
      </p>
    </div>
  </section>

  <section class="card">
    <h2>Säkerhet</h2>
    <div class="content">
      <p class="hint">Titta på vägen. Låt en passagerare hantera appen. Värdena är ungefärliga och beror på telefonmodell och montering.</p>
    </div>
  </section>

  <div class="footer">v1.0 • lokal HTML, ingen internetåtkomst</div>
</div>

<script>
(function(){
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const toFixed = (v,n=1)=>Number.isFinite(v)?v.toFixed(n):"—";

  let rawRoll=0, rawPitch=0;
  let roll=0, pitch=0;
  let rollZero=0, pitchZero=0;
  let alpha=0.15;
  let running=false;

  const rollTxt = document.getElementById('rollTxt');
  const rollNum = document.getElementById('rollNum');
  const pitchNum = document.getElementById('pitchNum');
  const gradeNum = document.getElementById('gradeNum');
  const bubble = document.getElementById('bubble');
  const hline = document.getElementById('hline');
  const alphaInput = document.getElementById('alpha');
  const alphaVal = document.getElementById('alphaVal');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const fsBtn = document.getElementById('fsBtn');

  // Draw ticks
  const ticks = document.getElementById('ticks');
  const r = 120;
  const tickSVG = document.createElementNS('http://www.w3.org/2000/svg','svg');
  tickSVG.setAttribute('viewBox', `0 0 ${r*2} ${r*2}`);
  tickSVG.setAttribute('class','tick');
  for (const deg of [-20,-15,-10,-5,0,5,10,15,20]){
    const rad = deg*Math.PI/180;
    const x1 = r + Math.sin(rad)*(r-10);
    const y1 = r - Math.cos(rad)*(r-10);
    const x2 = r + Math.sin(rad)*(r-2);
    const y2 = r - Math.cos(rad)*(r-2);
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1', x1); line.setAttribute('y1', y1);
    line.setAttribute('x2', x2); line.setAttribute('y2', y2);
    line.setAttribute('stroke', '#71717a'); line.setAttribute('stroke-width', '1');
    tickSVG.appendChild(line);
    if (deg % 10 === 0){
      const tx = r + Math.sin(rad)*(r-24);
      const ty = r - Math.cos(rad)*(r-24);
      const text = document.createElementNS('http://www.w3.org/2000/svg','text');
      text.setAttribute('x', tx); text.setAttribute('y', ty);
      text.setAttribute('text-anchor','middle');
      text.setAttribute('dominant-baseline','middle');
      text.textContent = String(deg);
      tickSVG.appendChild(text);
    }
  }
  ticks.appendChild(tickSVG);

  function updateUI(){
    // apply zeros
    const pr = rawRoll - rollZero;
    const pp = rawPitch - pitchZero;
    // low-pass
    roll = roll + alpha*(pr - roll);
    pitch = pitch + alpha*(pp - pitch);

    const grade = Math.tan(pitch*Math.PI/180)*100;
    rollTxt.textContent = toFixed(roll,1) + '°';
    rollNum.textContent = toFixed(roll,1) + '°';
    pitchNum.textContent = toFixed(pitch,1) + '°';
    gradeNum.textContent = toFixed(grade,1) + ' %';

    // bubble position
    const inner = r - 18;
    const rad = roll*Math.PI/180;
    const x = clamp(Math.sin(rad)*inner, -inner, inner);
    bubble.style.transform = `translate(${x}px, 0px)`;

    // horizon line rotation
    hline.style.transform = `rotate(${roll}deg)`;
  }

  let raf;
  function loop(){
    updateUI();
    raf = requestAnimationFrame(loop);
  }

  function handleOrientation(e){
    const beta = clamp((e.beta ?? 0), -90, 90);
    const gamma = clamp((e.gamma ?? 0), -90, 90);
    rawPitch = beta;
    rawRoll = gamma;
  }

  async function start(){
    try{
      // iOS permission request
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function'){
        const perm = await DeviceOrientationEvent.requestPermission();
        if (perm !== 'granted') return;
      }
      window.addEventListener('deviceorientation', handleOrientation, {passive:true});
      running = true;
      startBtn.style.display = 'none';
      stopBtn.style.display = 'inline-block';
      loop();
    }catch(e){ console.log(e); }
  }

  function stop(){
    window.removeEventListener('deviceorientation', handleOrientation);
    running = false;
    stopBtn.style.display = 'none';
    startBtn.style.display = 'inline-block';
    cancelAnimationFrame(raf);
  }

  function zeroBoth(){ rollZero = rawRoll; pitchZero = rawPitch; }
  function zeroRoll(){ rollZero = rawRoll; }
  function zeroPitch(){ pitchZero = rawPitch; }

  // wire UI
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  document.getElementById('zeroBoth').addEventListener('click', zeroBoth);
  document.getElementById('zeroRoll').addEventListener('click', zeroRoll);
  document.getElementById('zeroPitch').addEventListener('click', zeroPitch);
  alphaInput.addEventListener('input', (e)=>{
    alpha = parseFloat(e.target.value);
    alphaVal.textContent = alpha.toFixed(2);
  });
  fsBtn.addEventListener('click', async ()=>{
    const el = document.documentElement;
    if (el.requestFullscreen) await el.requestFullscreen();
  });

  // Kick off UI loop so numbers update even before sensors
  loop();
})();
</script>
</body>
</html>
